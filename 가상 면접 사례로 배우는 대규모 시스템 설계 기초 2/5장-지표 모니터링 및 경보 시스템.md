# 5장. 지표 모니터링 및 경보시스템
지표 모니터링 및 경보시스템은 인프라의 상태를 선명하게 볼 수 있도록 하여 높은 가용성과 안정성을 달성할 수 있게 함.


## 1단계: 문제 이해 및 설계 범위 확정
**개략적 요구사항 및 가정**
</br>대규모 인프라 모니터링을 해야함
- 일간 능동 사용자수 1억명
- 서버 풀 1,000대, 풀당 서버 수 100개, 서버당 100개의 운영지표를 수집한다고 가정하면 천만개 수준의 지표 모니터링 필요
- 일주일간은 수집데이터 원본 보관, 30일간은 1분 단위로 변환하여 보관, 1년간은 1시간 단위로 변환하여 보관

모니터링할 지표는 다음과 같은
- CPU사률
- 요청 수
- 메모리 사용량
- 메시지 큐 내의 메시지 수


**비기능 요구사항**
- 규모 확장성 : 늘어나는 지표 수와 경보의 양에 맞게 시스템이 확장가능해야함
- 낮은 응답 지연 : 대시보드와 경보를 신속하게 처리할 수 있도록 질의에 대한 낮은 응답 지연을 보장해야함
- 안정성 : 중요경보를 놓치지않도록 높은 안정성 제공 필요
- 유연성 : 미래의 신기술을 쉽게 통합 가능하도록 유연하게 변경가능한 파이프라인을 이용하여 구축 필요

## 2단계: 개략적 설계안 제시 및 동의 구하기
시스템 구축을 위해 기본적 사항과 데이터모델, 개략적 설계안에 대한 논의가 필요하다.

**기본적 사항**
</br>지표모니터링 및 경보시스템은 일반적으로 다섯가지 컴포넌트를 이용한다.
- 데이터 수집 : 여러 출처로부터 지표 데이터를 수집
- 데이터 전송 : 지표 데이터를 지표 모니터링 시스템으로 전송
- 데이터 저장소 : 전송되어 오는 데이터를 정리하고 저장
- 경보 : 밀려오는 데이터를 분석하고 이상징후를 감지하여 경보를 발생시킨다.
- 시각화 : 데이터를 차트나 그래프 등으로 제공한다.

**데이터모델**
</br>지표 데이터는 통상 시계열 데이터 형태로 기록한다.

- ex) 테이블로 표현한 데이터 예

| metric_name | cpu.load          |
|-------------|-------------------|
| labels      | host:i631,env:prod |
| timestamp   | 16139549294       |
| value       | 0.29              |

**데이터 접근 패턴**
![20240415_021122](https://github.com/rlatls1997/books/assets/62635664/3c720d03-2728-4989-9f53-e3c1fb45a7f9)
위 그림은 t4와 t7시간 사이에 발생한 error중에서 serverpool=s1이고 method=GET에 해당하는 오류를 질의했을때의 결과를 나타낸다.

y축에 붙은 레이블은 하나의 시계열 데이터를 나타내고,</br>
x축에 붙은 레이블은 시간을 나타낸다.

개략적 요구사항을 만족하려면 매일 천만개의 운영지표를 기록해야하고 이 지표들 중 대부분은 발생빈도가 높아서 시스템으로부터 오는 트래픽은 쓰기가 압도적으로 많은 것이다.

읽기부하는 그래프나 경보를 확인하는 패턴에 따라 일시적으로 증가하거나 사라질 수 있다.

시스템은 항상 많은 양의 쓰기 연산 부하를 감당해야한다는게 결론이다.

**데이터 저장소 시스템**
</br>저장소시스템을 직접 설계하거나 MySQL같은 범용 저장소시스템을 사용하는것은 추천되지 않는다.

범용 데이터베이스는 시계열데이터를 처리할 수 있으나 이 시스템의 부하를 감당하려면 전문적은 튜닝이 필요하고 통상적으로 관계형 데이터베이스는 시계열 데이터를 대상으로 하는 연산에 최적화되어있지 않다.
</br>또한 많은 양의 쓰기 연산이 지속적으로 발생하는 환경에서는 좋은 성능을 보이지 못한다.

NoSQL은?
</br>카산드라, 빅테이블같은 경우 시계열 데이터 처리에 사용될 수 있으나 이런 데이터베이스에 시계열 데이터를 효과적으로 저장하고 질의하기 위해선 확장이 용이한 스키마를 설계해야하는데 그러려면 데이터베이스의 내부 구조에 대한 해박한 지식이 필요하다.

시계열데이터에 최적화된 저장소시스템은 많고,
</br>이는 같은 양의 시계열 데이터를 더 적은 서버에 보관할 수 있다.

시장에서 인기있는 시계열 데이터베이스는 influxDB, 프로메테우스 등이 있으며 다량의 시계열 데이터를 저장하고 빠른 실시간 분석을 지원한다.

8코어 cpu, 32gb ram을 갖춘 influxDB서버 한대는 초당 250,000회의 쓰기연산 처리가 가능하다.


**개략적 설계안**
![20240415_022520](https://github.com/rlatls1997/books/assets/62635664/61ce0bc2-4586-4091-a788-1ff0ed2b5435)

- 지표 출처 : 지표 데이터가 만들어지는곳.</br>애플리케이션 서버, SQL데이터베이스, 메시지 큐 등..
- 지표 수집기 : 지표 데이터를 수집하고 시계열 데이터에 기록하는 역할
- 시계열 데이터베이스 : 지표 데이터를 시계열 데이터 형태로 보관하는 저장소.</br>다량의 시계열 데이터 분석 및 요약에 적합하도록 설계된 질의 인터페이스 제공
- 질의 서비스 : 시계열 데이터에 보관된 데이터를 질의하고 가져오는 과정을 돕는 서비스.
- 경보시스템 : 경보를 받아야하는 대상으로 경보 알림을 전송하는 역할을 하는 시스템
- 시각화 시스템 : 지표를 다양한 형태의 그래프/차트로 시각화하는 기능을 제공하는 시스템


## 3단계: 상세 설계
핵심적 컴포넌트나 처리 흐름에 대한 상세 설계안에 대해 알아본다.

### 3-1. 지표 수집
카운터, CPU사용량같은 지표수집은 데이터가 소실되어도 큰 문제가 없다.
</br>그러므로 지표를 보내는 클라이언트는 데이터가 잘 전송되었는지 크게 신경쓸 필요가 없다.

지표가 어떤 흐름으로 수집되는지 살펴보자.
![20240415_023032](https://github.com/rlatls1997/books/assets/62635664/9253c259-60e9-424f-843d-1832c75b4018)

**풀 VS 푸시 모델**
</br>지표 데이터의 수집 방법에는 두가지 모델이 존재.
두 모델에 대해 알아본다.

**풀 모델**
![20240415_023325](https://github.com/rlatls1997/books/assets/62635664/f8652a23-0106-4a4c-be70-a2c76bc010c2)
실행중인 애플리케이션에서 주기적으로 지표데이터를 가져오는 지표수집기가 흐름의 중심이다.
</br>이 접근법에서는 지표 수집기가 데이터를 가져올 서비스 목록을 알아야한다.

지표수집기가 데이터를 가져올 서비스 목록을 알고 있는 방법으로는,
1. 지표수집기 서버 안에 모든 서비스 엔드포인트의 DNS/IP정보를 담은 파일을 두는 방법
   </br>이는 서버가 수시로 추가/삭제되는 대규모 운영환경에는 적용하기 어렵다
2. 각 서비스가 자신의 가용성 관련 정보를 주키퍼같은 SDS(서비스 탐색 서비스)에 기록하고 SDS는 서비스 엔드 포인트 목록에 변화가 생길 때마다 지표수집기에 통보하는 방법

2번 흐름을 상세히 살펴보면
![20240415_024134](https://github.com/rlatls1997/books/assets/62635664/e3f5d216-c890-4410-beb5-e08781d26233)
1. 지표 수집기는 SDS에서 서비스 엔드포인트 설정 메타데이터 목록을 가져온다.
   </br>메타데이터에는 지표수집주기, IP주소, 타임아웃, retry parameter등이 기록되어있음
2. 지표수집기는 http엔드포인트(/metrics)에서 지표데이터를 가져온다. 일반적으로 이런 엔드포인트를 수집기에 노출하기 위해 특정 클라이언트 라이브러리를 추가한다.
3. 지표수집기는 서비스 엔드포인트 목록의 변화를 통지받기 위해 변경 이벤트 알림 콜백을 서비스 탐색 컴포넌트에 등록할 수 있다.
   </br>또는 주기적으로 서비스 탐색 컴포넌트에서 엔드포인트 목록을 다시 가져와도 된다.

(지표수집 대상 서비스의 정보를 저장하기 위해 서비스 탐색 컴포넌트를 사용하는 것의 이점이 잘 이해되지 않음. 주키퍼에 서비스 정보를 저장하는 것과 파일에 서비스 정보를 저장하는 것은 뭐가 그렇게 다른것인지?)


**중재 메커니즘**
</br>
수많은 지표데이터를 수집하기 위해서는 지표 수집기 서버 한대로는 부족하다.
</br>지버 수집시 서버 풀을 만들어서 설계안에서 다루는 지표 데이터 귬보를 감당할 수 있다.
</br>이 때 여러 서버가 같은 출처에서 데이터를 중복으로 가져올 가능성이 있다.
</br>따라서 지표 수집 서버간에 중재 메커니즘이 필요하다.

중재 메커니즘을 구현하기 위해 안정 해시 링을 사용할 수 있다.
해시 링 구간마다 해당 구간에 속한 서버로부터 생산되는 지표의 수집을 담당하는 수집기 서버를 지정하는 것이다.
![20240415_025312](https://github.com/rlatls1997/books/assets/62635664/87db2d0c-ec51-4b16-ba1d-37d41b8c4528)

**푸시 모델**
</br>푸시 모델은 지표 출처에 해당하는 서버가 직접 지표를 수집기에 전송하는 모델이다.
</br>푸시모델의 경우 모니터링 대상 서버에 통상 수집 에이전트라고 부르는 소프트웨어를 설치한다.
![20240415_025519](https://github.com/rlatls1997/books/assets/62635664/fe522e55-48df-4f49-a8aa-70cd29e66fbe)

데이터 전송 트래픽의 양이 막대하여 수집기가 일시적으로 전송되는 데이터를 처리하지 못하는 경우,
</br>에이전트는 내부의 소규모 버퍼에 데이터를 일시적으로 보관해두고 나중에 재전송할수도 있다.
</br>하지만 에이전트가 위치한 서버클러스터가 자동 규모 확장이 가능하다면 서버가 동적으로 추가, 삭제되는 과정에서 데이터가 소실될 우려가 있다.

푸시모델의 경우,
</br>지표수집기가 지표데이터를 제때 처리하지 못하는 일을 방지하려면 지표 수집기 클러스터 자체도 자동 규모 확장이 가능하도록 수정하고
</br>그 앞에 로드밸런서를 두는 것이 바람직하다.
![20240415_030014](https://github.com/rlatls1997/books/assets/62635664/4e3f04d5-e1ec-4e56-8f78-ecbc869ba3ac)

**풀 모델 VS 푸시 모델 장단점 비교**
</br>풀모델 예시로는 프로메테우스, 푸시모델 예시로는 아마존 클라우드와치, 그라파이트 등이 존재.

두 모델의 장단점은?

|                    | 풀 모델                                                           | 푸시 모델                                                                                   |
|--------------------|----------------------------------------------------------------|-----------------------------------------------------------------------------------------|
| 손쉬운 디버깅            | 애플리케이션 서버에 엔드포인트를 두도록 강제하므로 언제든 지표데이터를 볼 수 있으므로 풀 모델이 더 낫다.    |                                                                                         |
| 상태 진단              | 애플리케이션 서버가 풀 요청에 응답하지 않으면 서버에 장애가 발생한것으로 진달할 수 있으므로 풀모델이 더 낫다. | 지표를 받지 못하는 것이 네트워크 장애때문인지, 서버장애때문인지 알 수 없다.                                             |
| 생존기간이 짧은 프로세스      | -                                                              | 생명주기가 짧은 일괄 작업 프로세스의 경우 수집기가 지표를 끌어가기도 전에 종료되어버릴 수 있다(풀 모델의 경우 그렇다는 말). 그런점에서 푸시모델이 낫다. |
| 방화벽 등의 복잡한 네트워크 구성 | 수집기 서버가 엔드포인트에 접근 가능하도록 구성되어야 한다. 세심한 설계가 필요.                  | 지표수집기가 버틸수만 있다면 어디서 오는 지표라도 수집 가능하다. 푸시모델이 더 나음                                         |
| 성능                 | 풀 모델은 일반적으로 TCP를 사용함                                           | 푸시모델은 보통 UDP를 사용함. 빠름.                                                                  |
| 데이터 신빙성            | 지표데이터를 가져올 서버를 미리 정의하므로 수집한 데이터를 믿을 수 있다.                      | 아무나 지표수집기에 데이터를 모낼 수 있는 문제가 존재하나 white list나 인증을 강제하면 해결가능                              |


### 3-2 지표 전송 파이프라인의 규모 확장
풀, 푸시모델 채탱에 상관없이 지표수집기는 서버 클러스터의 형태로 엄청난 양의 데이터를 받아 처리해야한다.
</br>또한 자동으로 규모확장 가능하도록 하여 항상 데이터 처리에 충분한 수집기 서버가 존재하도록 해야한다.

지표수집기가 아닌 시계열데이터베이스에 장애가 발생할 경우 데이터 손실이 발생할 수 있으나 큐를 두어 문제를 해소할 수 있다.
- 카프카 메시지큐를 두어 데이터 손실 발생 가능성 축소
  ![20240415_031407](https://github.com/rlatls1997/books/assets/62635664/1799c8df-6f40-42c7-a73f-d9e38fc8c940)

카프카를 사용하여 다음의 이점을 얻을 수 있다.
- 데이터 수집 컴포넌트와 처리 컴포넌트 사이의 결합도를 낮춤
- 데이터베이스에 장애 발생시에도 데이터 소실이 없음

또한 카프카의 파티션 메커니즘을 사용하여 시스템을 다양한 규모로 확장할 수 있다.(토픽?, p177)

### 3-3 데이터 집계 지점
지표집계를 다양한 시점에서 실행할 수 있다.

- 수집 에이전트가 집계하는 방안
클라이언트에 설치된 수집 에이전트는 복잡한 집계 로직을 지원하기 어렵다.
  </br>어떤 카운터 값을 분단위로 집계하여 지표수집기로 보내는 등의 집계정도는 가능함

- 데이터 수집 파이프라인에서 집계하는 방안
데이터를 저장소에 기록하기 전에 집계하려면 플링크 같은 스트림 프로세싱 엔진이 필요하다.
  </br>데이터베이스에는 집계된 결과만 기록하여 기록되는 양은 엄청 줄어들 것이지만,
  </br>이 방안으로는 늦게 도착하는 지표 데이터의 처리가 어렵고 원본데이터를 보관하지 않기때문에 정밀도나 유연성 측면에서 손해를 볼 수 있다.

- 질의 시에 집계하는 방안
원본데이터를 그대로 보관하고 질의할때 집계하는방안.
  </br>데이터 손실문제는 없으나 질의를 처리하는 순간에 전체 데이터세트를 대상으로 집계 결과를 계산해야하므로 느릴것이다.


### 3-4 질의 서비스
질의 서비스는 질의 서버 클러스터 형태로 구현되며 시각화 또는 경보 시슽메에서 접수된 요청을 시계열 데이터베이스를 통해 처리하는 역할을 담당한다.

질의 처리 전담 서비스를 별도로 두는 것의 장점은,
클라이언트(시각화 또는 경보시스템)와 시계열 데이터베이스 사이의 결합도를 낮추고 이는 시계열 데이터베이스의 교체를 수월하게 만든다.

**캐시계층**
</br>질의 결과를 저장할 캐시서버를 도입하여 질의 부하를 낮추고 질의 성능을 높일 수 있다.
![20240415_032648](https://github.com/rlatls1997/books/assets/62635664/ca12126b-5e01-4aa7-92f8-a9b6f2f88996)

**질의 서비스를 두면 곤란한 경우**
</br>대부분의 상용 시각화 및 경보시스템은 시장에서 널리 사용되는 시계열 데이터베이스와의 연동을 처리하는 강력한 플러그인을 이미 갖추고 있는 경우가 많아서 별도 캐시를 도입할 필요가 없는 시계열 데이터베이스도 있다.

**시계열 데이터베이스 질의어**
</br>보통 프로메테우스, InfluxDB같은 지표모니터링 시스템들은 독자 질의어를 제공한다.
시계열 데이터베이스 분석에 최적화되어 SQL보다 간단하다.

### 3-5 저장소 계층
저장소계층을 자세히..

**저장용량 최적화**
</br>지표 모니터링 시스템에 저장할 데이터양은 막대하기에 이 문제를 공략할 필요가 있다.
</br>몇가지 방법을 살펴보자.

- 데이터 인코딩 및 압축
  </br>인코딩 및 압축을 통해 크기를 상당히 줄일 수 있다.
  </br>좋은 시계열데이터는 대부분 이 기능을 내장하고 있다.
  ![20240415_033332](https://github.com/rlatls1997/books/assets/62635664/17437d94-3a8c-4a4b-a7f9-61fdcefcf317)
  </br>데이터를 온전히 저장하는 대신 1610083731, 10, 10, 9, 11 과 같이 저장할 수 있음

- 다운샘플링
  </br>데이터의 해상도를 낮춰 저장소 요구량을 줄이는 기법
  </br>이번 챕터의 요구안처럼 보관기간에 따라 저장하는 데이터의 해상도를 줄이는 등..

- 냉동 저장소
  </br>잘 사용되지 않는 비활성 데이터를 보관하는 곳이다.

### 3-6 경보 시스템
경보시스템의 구성사례이다.
![20240415_033639](https://github.com/rlatls1997/books/assets/62635664/348856a7-56b8-4f82-a705-df70b17ba60d)

경보를 처리하는 흐름은 다음과 같다.

1. 경보 규칙 설정 파일을 가져와 캐시서버에 보관한다.
   </br>경보 규칙은 디스크에 파일 상태로 보관한다.
2. 경보 관리자는 경보 설정 내역을 캐시에서 가져온다.
3. 경보관리자는 설정된 규칙에 근거하여 지정된 시간마다 질의 서비스를 호출한다.
   </br>질의 결과가 설정된 임계값을 위반한다면 경보 이벤트를 생성한다.
4. 경보저장소는 카-값 저장소이다. 경보의 상태가 여기에 보관된다.
5. 경보 이벤트를 카프카에 전달한다.
6. 경보 소비자는 카프카에서 경보 이벤트를 읽는다.
7. 경보 소비자는 읽은 경보 이벤트를 처리하여 다양한 채널로 알림을 전송한다.

**경보시스템 - 만들 것인가 구매할 것인가**
</br>경보시스템은 시장에 많다. 그리고 대부분 유명 시계열 데이터베이스와 통합되어있다.
</br>실무에선 경보시스템을 구현한다는 아이디어는 채택되기 어렵다.

### 3-7 시각화 시스템
시각화시스템은 데이터계층 위에 만들어진다.
다양한 지표 정보를 표시한다.

품질좋은 시각화 시스템의 구현은 어렵고 이미 좋은 상용품이 있다. (면접에서는 상용품을 쓰자고 하자, 그라파나같은..)

## 4단계: 마무리
지표 모니터링 경보 시스템의 설계안에 대해 살펴보았다.
</br>데이터 수집, 시계열 데이터베이스, 경보, 시각화 등에 대해 개략적으로 살펴보았고,
</br>중요 기술과 컴포넌트에 대해 집중적으로 살펴보았다.

- 지표데이터 수집 모델(풀, 푸시)
- 카프카를 활용한 규모 확장 방안
- 최적 시계열 데이터베이스의 선정
- 데이터 크기 절감
