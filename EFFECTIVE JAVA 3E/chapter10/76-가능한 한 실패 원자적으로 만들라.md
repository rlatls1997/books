## 76. 가능한 한 실패 원자적으로 만들라

예외가 발생하더라도 그 객체가 여전히 정상적으로 사용할 수 있다면 좋을 것이다.

검사 예외를 던진 경우라면 호출자가 오류 상태를 복구할 수 있을 테니 특히 더 유용할 것이다.

**일반화하면, 호출된 메서드가 실패하더라도 해당 객체는 메서드 호출 전 상태를 유지해야한다**

이러한 특성을 실패 원자적이라고 한다.

**메서드를 실패 원자적으로 만드는 방법**

- 불변 객체로 설계한다. 불편 객체는 태생적으로 실패 원자적이다.
- 가변객체라면 작업 수행에 앞서 매개변수의 유효성을 검사하는 방법이 있다.

```java
public Object pop() {
	if(size == 0){
		throw new EmptyStackException();
	}

	Object result = elements[--size];
	elements[size] = null; // 다 쓴 객체 참조 해제
	return result;
}
```

객체의 내부 상태를 변경하지 전에 잠재적 예외의 가능성 대부분을 걸러낸다.

위와 비슷하게 실패할 가능성이 있는 모든 코드를 객체의 상태를 바꾸는 코드보다 앞에 배치하는 방법도 있다.

- 객체의 임시 복사본에서 작업을 수행한 다음 작업이 성공적으로 완료되면 원래 객체와 교체하는 방법.
  데이터를 임시 자료구조에 저장하여 작업하는게 더 빠를 때 사용하기 좋다
- 작업도중 발생하는 실패를 가로채는 복구 코드를 작성하여 작업 전 상태로 되돌리는 방법
  자주 쓰이는 방법은 아님

항상 실패 원자성을 달성할 수 있는 것은 아니다.

두 스레드에서 동기화 없이 작업하는 경우 객체의 일관성이 깨졌을 때 ConcurrentMdificationException을 잡았다고 하더라도 객체가 사용가능하다고 판단해서는 안된다.

실패원자적으로 만들 수 있더라도 실패원자성을 달성하기 위한 비용이나 복잡도가 아주 큰 경우도 있다.

메서드 명세에 기술한 예외라면 예외가 발생하더라도 객체의 상태는 메서드 호출 전과 똑같이 유지돼야 한다는 것이 기본 규칙이다. 이 규칙이 지켜지지 않는다면 실패시의 객체 상태를 API에 명시해야 한다.